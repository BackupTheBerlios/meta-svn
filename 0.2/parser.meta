syntax
	autokey '.'
	callStart '('
	callEnd ')'
	root '/'
	search '$'
	negative '-'
	fraction '/'
	endOfFile 65535
	indentation '\t'
	unixNewLine '\n'
	windowsNewLine "\r\n"
	function '|'
	string '"'
	lookupStart '['
	lookupEnd ']'
	emptyMap '0'
	call ' '
	select '.'
	character "'"
	assignment ' '
	space ' '
	tab '\t'
	current "current"
	integer "0123456789"
	lookupStringForbidden
		. call
		. indentation
		. '\r'
		. '\n'
		. assignment
		. select
		. function
		. string
		. lookupStart
		. lookupEnd
		. emptyMap
		. search
		. root
		. callStart
		. callEnd
		. character
. "this should not really be defined here, its kinda unnecessary"
codeKeys
	parameterName "parameterName"
	root "root"
	search "search"
	lookup "lookup"
	current "current"
	scope "scope"
	literal "literal"
	function "function"
	call "call"
	callable "callable"
	argument "argument"
	select "select"
	program "program"
	key "key"
	value "value"
arg|
	text arg.text
	file arg.file
	index 0
	line 1
	column 0
	startOfFile 1
	indentationCount -1
	defaultKeys 0
	newline alternatives
		. character syntax.unixNewLine
		. stringRule syntax.windowsNewLine
	endOfLine sequence
		action
			do match
			rule zeroOrMore action
				do match
				rule alternatives
					. character syntax.space
					. character syntax.tab
		action
			do match
			rule newLine
	integer
		rule sequence
			. optional character syntax.negative
			. oneOrMore syntax.integer
		result
			text|Meta.Number.Parse text
	indentation
		rule alternatives
			.
				|if
					condition startOfFile
					then
						|
							$startOfFile 0
							result 0
			. sequence
				. endOfLine
				. 
					|loop
						add
							indentationCount
							1
						syntax.indentation
		result
			|
				$indentationCount add
					indentationCount
					1
	endOfLinePreserve sequence
		. zeroOrMore alternatives
			. character syntax.space
			. character syntax.tab
		. alternatives
			character syntax.unixNewLine
			stringRule syntax.windowsNewLine
	sameIndentation
		|loop
			. indentationCount
			. syntax.indentation
	stringLine zeroOrMore characterExcept
		. syntax.unixNewLine
		. syntax.windowsNewLine[0]
	stringDedentation 
		rule sequence
			. endOfLine
			. loop
				. subtract
					. pa.indentationCount
					. 1
				. syntax.indentation
		result
			|
				$indentationCount subtract
					. indentationCount
					. 1
	characterDataExpression sequence
		. character syntax.character
		. characterExcept syntax.character
		. character syntax.character
	string sequence
		. syntax.string
		. alternatives
			. oneOrMore characterExcept
				. syntax.unixNewLine
				. syntax.windowsNewLine[0]
				. syntax.string
			. sequence
				. indentation
				. sequence
					stringLine
					zeroOrMore
						. endOfLinePreserve
						. sameIndentation
						. sequence
							. literalRule syntax.unixNewLine.ToString()
							. StringLine
				. stringDedentation
		. syntax.string			
	number sequence
		. oneOrMore syntax.integer
		. optional sequence
			. character syntax.fraction
			. oneOrMore syntax.integer
	lookupString oneOrMore characterExcept syntax.lookupStringForbidden
	map sequence
		. indentation
		. entry
		. oneOrMore sequence alternatives
			. sequence
				. sameIndentation
				. Entry.Match(parser, out matched)));
			. dedentation
	value alternatives
		. map
		. string,
		. number
		. characterDataExpression
	lookupAnything sequence
		. character syntax.lookupStart
		. value
		. zeroOrMore syntax.indentation
		. character syntax.lookupEnd
	entry sequence
		. function
		. alternatives
			. lookupString
			. lookupAnything
		. character syntax.assignment
		. value.Match
	function sequence
		. CodeKeys.ParameterName
		. zeroOrMore characterExcept
			syntax.string,
			syntax.function,
			syntax.unixNewLine
		. sequence character syntax.function
		. expressionData
	file sequence
		. optional sequence
			. stringRule "#!"
			. zeroOrMore characterExcept syntax.unixNewLine
			. EndOfLine
		. Map
	call 
		. CodeKeys.Call
		. sequence
		. CodeKeys.Callable
		. alternatives
			. Select,
			. ExplicitCall
		. CodeKeys.Argument
		. alternatives
			. sequence(
				. alternatives
					. syntax.call
					. syntax.indentation
				. expression
			. program
	dedentation
		|
			$indentationCount subtract
				indentationCount
				1
	functionExpression = sequence
		. CodeKeys.Key
		.
			.
				[CodeKeys.Lookup]
					[CodeKeys.Literal] CodeKeys.Function
		. CodeKeys.Value
		. CodeKeys.Literal
		. function
	whitespace zeroOrMore alternatives
		. syntax.tab
		. syntax.space
	emptyMap
		rule syntax.emptyMap
		result 0
	literalExpression sequence
		. CodeKeys.Literal),
		. alternatives
			. emptyMap
			. string
			. number
			. characterDataExpression
	lookupAnythingExpression sequence
		. syntax.lookupStart
		. Expression
		. zeroOrMore syntax.indentation
		. syntax.lookupEnd
	lookupStringExpression sequence 
		. CodeKeys.Literal
		. LookupString
	current sequence
		rule syntax.current
		result
			current 0
	root sequence
		rule syntax.root
		result
			[CodeKeys.Root] 0
	lookup alternatives
		. Current
		. sequence
			. CodeKeys.Lookup
			. alternatives
				. lookupStringExpression
				. lookupAnythingExpression
	search sequence
		. CodeKeys.Search
		. alternatives
			. LookupStringExpression
			. LookupAnythingExpression
	select sequence
		. CodeKeys.Select
		. sequence
			. 1
			. alternatives
				root
				search,
				lookup,
			. zeroOrMore
				. syntax.select
				. Lookup
	keysSearch sequence
		. syntax.search
		. search
	AutokeyLookup
		rule syntax.autokey
		result
			[CodeKeys.Lookup]
				[CodeKeys.Literal] last defaultKeys
			$defaultKeys push.Push(p.defaultKeys.Pop() + 1);
			return null;
	keys sequence
		. 1
		. alternatives
			. keysSearch,
			. lookup,
			. autokeyLookup
		. zeroOrMore
			. sequence
				. syntax.select
				. Lookup	
	statement sequence
		. alternatives
			. functionExpression
			. alternatives
				. sequence
					. CodeKeys.Key
					. keys
					. optional syntax.assignment
					. CodeKeys.Value
					. expression
					. endOfLine
	program sequence
		. CodeKeys.Program
		. p.defaultKeys.Push(1);
		. sequence
			. indentation
			. 1
			. statement
			. zeroOrMore sequence
				. alternatives
					. sameIndentation
					. dedentation
				. statement
		. p.defaultKeys.Pop();